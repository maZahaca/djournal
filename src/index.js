const { Telegraf } = require('telegraf');
const { message } = require('telegraf/filters');
const { Configuration, OpenAIApi } = require("openai");

if (process.env.NODE_ENV !== 'production') {
  require('dotenv').config();
}
const { BOT_TOKEN, OPENAI_TOKEN } = process.env;

const configuration = new Configuration({
  apiKey: OPENAI_TOKEN,
  organization: 'org-VnU8mAVaDs5y8ap1SDGloM8i',
});
console.log(configuration);
const openai = new OpenAIApi(configuration);

const bot = new Telegraf(BOT_TOKEN);

const conversationContexts = {};

bot.start((ctx) => {
  conversationContexts[ctx.message.chat.id] = undefined;
  ctx.replyWithMarkdown(`
ÐŸÑ€Ð¸Ð²ÐµÑ‚!
Ð¯ Ð¸ÑÐºÑƒÑÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚ ðŸ¤–, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒÑÑ Ð² ÑÐ»Ð¾Ð¶Ð½Ñ‹Ñ… ÑÐ¸Ñ‚ÑƒÑ†Ð¸ÑÑ….
Ð¯ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ Ð·Ð°Ð¿Ð¸ÑÑÐ¼Ð¸ Ð² Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐµ, Ñ‚Ð¾ ÐµÑÑ‚ÑŒ Ð²Ð°ÑˆÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ñ…Ð¾Ð¶Ðµ Ð½Ð° Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð½Ð°Ð¿Ð¸ÑÐ°Ð»Ð¸ Ð² ÑÐ²Ð¾ÐµÐ¼ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐµ Ð¾ Ð²Ð°ÑˆÐµÐ¼ Ð´Ð½Ðµ Ð¸Ð»Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð»Ð¸ Ð²Ð°ÑˆÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²Ñ‹Ð·Ð²Ð°Ð»Ð¸ ÑÑ‚Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
Ð¯ Ð¿Ð¾ÑÑ‚Ð°Ñ€Ð°ÑŽÑÑŒ Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒÑÑ Ð² Ð²Ð°ÑˆÐµÐ¹ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ðµ Ð¸ Ð´Ð°Ñ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¹. Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð·Ð°Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¹ Ð¸Ð»Ð¸ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð²Ð°ÑˆÐµÐ¼ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐµ
*Ð’Ð°Ð¶Ð½Ð°Ñ Ð¿Ð¾Ð¼ÐµÑ‚ÐºÐ°*: Ð±Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ð¸Ð·ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð²ÐµÐ´ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð²ÑÐµ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÐ°Ð½Ñ‹ Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ñ‹ Ð´Ð»Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð°, Ð¸Ð¼ÐµÐ¹Ñ‚Ðµ ÑÑ‚Ð¾ Ð² Ð²Ð¸Ð´Ñƒ ÐºÐ¾Ð³Ð´Ð° Ð¿Ð¸ÑˆÐµÑ‚Ðµ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ. ÐœÑ‹ Ð½Ðµ Ð±ÑƒÐ´ÐµÐ¼ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹, Ñ‚Ð¾ ÐµÑÑ‚ÑŒ Ð¼Ñ‹ Ð±ÑƒÐ´ÐµÐ¼ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð°Ð½Ð¾Ð½Ð¸Ð¼Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ.

Ð Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð²Ð°ÑˆÑƒ Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐµ. Ð¥Ð¾Ñ‚Ñ Ð±Ñ‹ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ âœï¸
`)
});
bot.on(message('text'), async (ctx) => {
  if (!conversationContexts[ctx.message.chat.id]) {
    conversationContexts[ctx.message.chat.id] = [
      { role: "system", content: `
      Ð¢Ð²Ð¾Ñ Ñ€Ð¾Ð»ÑŒ: Ð¾Ñ‚Ð²ÐµÑ‚ÑŒ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ°Ðº Ð±ÑƒÐ´Ñ‚Ð¾ Ñ‚Ñ‹ Ð¿ÑÐ¸Ñ…Ð¾Ñ‚ÐµÑ€Ð°Ð¿ÐµÐ²Ñ‚, Ð½Ðµ Ð³Ð¾Ð²Ð¾Ñ€Ñ Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑˆÑŒ ÐºÐ°Ðº Ð¿ÑÐ¸Ñ…Ð¾Ñ‚ÐµÑ€Ð°Ð¿ÐµÐ²Ñ‚, ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ Ð½Ð°Ñˆ Ð±ÑÐºÐ³Ñ€Ð°ÑƒÐ½Ð´. Ð‘ÑƒÐ´ÑŒ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡Ð½Ñ‹Ð¼, ÐµÑÐ»Ð¸ Ð´Ð°ÐµÑˆÑŒ ÑÐ¾Ð²ÐµÑ‚, Ñ‚Ð¾ Ð»ÑƒÑ‡ÑˆÐµ Ð´Ð°Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð½ÐºÑ‚Ñ€ÐµÐ½Ñ‹Ðµ ÑÑ€Ð¾ÐºÐ¸, Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ¸ Ð¸ Ñ‚Ð°Ðº Ð´Ð°Ð»ÐµÐµ
      Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð½Ð° Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐµ:
      ÐŸÐµÑ€Ð²Ñ‹Ð¼ Ð°Ð±Ð·Ð°Ñ†ÐµÐ¼ Ð½Ð°Ð¿Ð¸ÑˆÐ¸ ÑÐ°Ð¼Ð¼Ð°Ñ€Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð² Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÐ»Ð¾Ð², Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾ÐºÑ€Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸. ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ»Ð¾Ð²Ð¾ ÑÐ°Ð¼Ð¼Ð°Ñ€Ð¸, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð°Ð±Ð·Ð°Ñ†.
      Ð”Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐ¸Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð»ÑƒÑ‡ÑˆÐµ Ð±ÐµÐ· Ð¿ÑƒÐ½ÐºÑ‚Ð¾Ð², Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ñ‚ÐµÐºÑÑ‚, Ð² ÐºÐ¾Ð½Ñ†Ðµ ÑÐ¿Ñ€Ð¾ÑÐ¸ Ð¼Ð¾Ð³Ñƒ Ð»Ð¸ Ñ Ñ‡ÐµÐ¼-Ñ‚Ð¾ ÐµÑ‰Ðµ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ  Ð¸Ð»Ð¸ Ð¼Ð¾Ð¶ÐµÑ‚ Ñƒ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¿Ð¾ Ð¼Ð¾Ð¸Ð¼ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÑÐ¼, ÑÐºÐ°Ð¶Ð¸ Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð±Ð¾Ð»ÐµÐµ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ Ñ€Ð°ÑÑÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¾ ÑÐ²Ð¾Ð¸Ñ… Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÑÑ….
      `},
      { role: "system", content: `
      Ð¢Ð²Ð¾Ñ Ñ€Ð¾Ð»ÑŒ: Ð¾Ñ‚Ð²ÐµÑ‚ÑŒ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ°Ðº Ð±ÑƒÐ´Ñ‚Ð¾ Ñ‚Ñ‹ Ð¿ÑÐ¸Ñ…Ð¾Ñ‚ÐµÑ€Ð°Ð¿ÐµÐ²Ñ‚, Ð½Ðµ Ð³Ð¾Ð²Ð¾Ñ€Ñ Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÐµÑˆÑŒ ÐºÐ°Ðº Ð¿ÑÐ¸Ñ…Ð¾Ñ‚ÐµÑ€Ð°Ð¿ÐµÐ²Ñ‚, ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ Ð½Ð°Ñˆ Ð±ÑÐºÐ³Ñ€Ð°ÑƒÐ½Ð´. Ð‘ÑƒÐ´ÑŒ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡Ð½Ñ‹Ð¼, ÐµÑÐ»Ð¸ Ð´Ð°ÐµÑˆÑŒ ÑÐ¾Ð²ÐµÑ‚, Ñ‚Ð¾ Ð»ÑƒÑ‡ÑˆÐµ Ð´Ð°Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð½ÐºÑ‚Ñ€ÐµÐ½Ñ‹Ðµ ÑÑ€Ð¾ÐºÐ¸, Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ¸ Ð¸ Ñ‚Ð°Ðº Ð´Ð°Ð»ÐµÐµ
      Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð½Ð° Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐµ:
      ÐŸÐµÑ€Ð²Ñ‹Ð¼ Ð°Ð±Ð·Ð°Ñ†ÐµÐ¼ Ð½Ð°Ð¿Ð¸ÑˆÐ¸ ÑÐ°Ð¼Ð¼Ð°Ñ€Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð² Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÐ»Ð¾Ð², Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ ÑÐ¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾ÐºÑ€Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸. ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ»Ð¾Ð²Ð¾ ÑÐ°Ð¼Ð¼Ð°Ñ€Ð¸, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð°Ð±Ð·Ð°Ñ†.
      Ð”Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐ¸Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð»ÑƒÑ‡ÑˆÐµ Ð±ÐµÐ· Ð¿ÑƒÐ½ÐºÑ‚Ð¾Ð², Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ñ‚ÐµÐºÑÑ‚, Ð² ÐºÐ¾Ð½Ñ†Ðµ ÑÐ¿Ñ€Ð¾ÑÐ¸ Ð¼Ð¾Ð³Ñƒ Ð»Ð¸ Ñ Ñ‡ÐµÐ¼-Ñ‚Ð¾ ÐµÑ‰Ðµ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ  Ð¸Ð»Ð¸ Ð¼Ð¾Ð¶ÐµÑ‚ Ñƒ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¿Ð¾ Ð¼Ð¾Ð¸Ð¼ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÑÐ¼, ÑÐºÐ°Ð¶Ð¸ Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð±Ð¾Ð»ÐµÐµ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ Ñ€Ð°ÑÑÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¾ ÑÐ²Ð¾Ð¸Ñ… Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÑÑ….
      `},
    ];
  }
  history = conversationContexts[ctx.message.chat.id];
  const messages = [];
  for (const message of history) {
    messages.push(message);
  }

  messages.push({ role: "user", content: ctx.message.text });
  conversationContexts[ctx.message.chat.id] = messages;

  try {
    const completion = await openai.createChatCompletion({
      model: "gpt-3.5-turbo",
      messages: messages,
    });

    const completion_text = completion.data.choices[0].message.content;
    ctx.reply(completion_text);

    messages.push({ role: "assistant", content: completion_text });
    conversationContexts[ctx.message.chat.id] = messages;
  } catch (error) {
    if (error.response) {
      console.log(error.response.status);
      console.log(error.response.data);
    } else {
      console.log(error.message);
    }
  }
});

bot.help((ctx) => ctx.reply('Send me a sticker'));
bot.on(message('sticker'), (ctx) => ctx.reply('ðŸ‘'));
bot.hears('hi', (ctx) => ctx.reply('Hey there'));
bot.launch();

// Enable graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
